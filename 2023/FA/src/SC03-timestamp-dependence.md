## آسیب‌پذیری: Timestamp Dependence

### توضیحات:
قرادادهای هوشمند در اتریوم اغلب مواقع برای اجرای توابع های وابسته به زمان، ماننده مزایده‌ها،قرعه کشی ها و آزادسازی توکن‌ها(token vesting) از `block.timesatamp` استفاده می‌کنند. این ویژگی کاملا ثابت و تغییر‌ناپذیر نیست، چراکه می‌تواند تا حدی توسط ماینری که بلاک را استخراج می‌کند، در حدود یک بازه 15 ثانیه‌ای (طبق استاندارد اتریوم) تنظیم شود. این موضوع یک آسیب‌پذیری ایجاد می‌کند که در آن یک ماینر می‌تواند به نفع خود زمان را دستکاری کند.

برای مثال، در یک مزایده غیرمتمرکز، ماینری که همزمان یک پیشنهاد دهنده نیز هست، میتواند `timestamp` را دستکاری کند تا مزایده را زودتر از موعد به نفع خود خاتمه دهد.


### مثال:
```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract DiceRoll {
    uint256 public lastBlockTime;

    constructor() payable {}

    function rollDice() external payable {
        require(msg.value == 5 ether, "Must send 5 ether to play"); // Player must send 5 ether to play
        require(block.timestamp != lastBlockTime, "Only 1 transaction per block allowed"); // Ensures only 1 transaction per block

        lastBlockTime = block.timestamp;

        // Player wins if the last digit of the block timestamp is less than 5
        if (block.timestamp % 10 < 5) {
            (bool sent,) = msg.sender.call{value: address(this).balance}("");
            require(sent, "Failed to send Ether");
        }
    }
}
```
### شدت آسیب‌پذیری:
- قراردادهای هوشمندی که از `timestamp` برای عملیات های حساس زمانی استفاده می‌کنند، در معرض دستکاری قراردارند. مهاجمان می‌توانند با تغییر `timestamp`، توابع را زودتر از موعد یا با تاخیر اجرا کنند و نتایج پیش بینی شده را برهم بزنند. این دستکاری می‌تواند منجر به مشکلاتی مانند دریافت پاداش‌ها زودتر از موعد یا به تعویق افتادن به روزرسانی های ضروری شودکه در نتیجه، عملکرد قرارداد را مختل می‌کند.

- با تغییر در `timestamp`، مهاجمان می‌توانند از مکانیسم های وابسته به زمان در قراردادها سوءاستفاده کنند. برای مثال، در یک قرعه کشی، مهاجم می‌تواند `timestamp` را به شکلی تنظیم کند که با شرایط خاصی همخوانی داشته باشد و شانس برنده شدن خود را افزایش دهد. علاوه بر این، آن‌ها ممکن است توابع را به سرعت و به طور مکرر اجرا کنند و منابع قرارداد را تخلیه کرده یا مزایای نا عادلانه ای به دست آورند.

- دستکاری `timestamp` می‌تواند به حملات front-running کمک کند، جایی که مهاجمان پیش از دیگران و در زمان‌های استراتژیک تراکنش ها را اجرا می‌کنند. این پیش بینی که تحت تاثیر `timestamp` کنترل شده توسط مهاجم است، به ویژه در زمینه‌های مالی آسیب‌زا است. چنین اقداماتی می‌تواند منجر به خسارت‌های قابل توجه برای دیگر مشارکت‌کنندگان و کسب سودهای غیرمنصفانه برای مهاجم شود.

### راهکارهای امنیتی:
- برای کاهش ریسک‌های ناشی از دستکاری `timestamp` و بهبود دقت و امنیت قراردادهای هوشمند، توصیه می‌شود از منابع زمانی خارجی و معتبر یا چندین منبع زمانی استفاده شود. این رویکرد به اطمینان از زمان‌بندی دقیق‌تر کمک می‌کند.

-اگر ناچار به استفاده از `block.timestamp` هستید، در نظر بگیرید که یک فاصله زمانی(time buffer) اضافه کنید. به عنوان مثال، می‌توانید قانونی تعیین کنید که یک مزایده تنها زمانی پایان یابد که `block.timestamp` بیشتر از زمان پایان مزایده به اضافه یک دقیقه باشد. این ویژگی باعث می‌شود که ماینرها نتوانند به راحتی زمان پایان را دستکاری کنند و نتیجه‌ای عادلانه‌تر برای شرکت‌کنندگان فراهم شود.
